(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const d of i.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&o(d)}).observe(document,{childList:!0,subtree:!0});function e(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=e(r);fetch(r.href,i)}})();class F{roomWidth=200;roomHeight=200;calculateVirtualObjects(t,e,o){const r=[],i=[],d={position:{x:0,y:0}};return e[0]&&i.push({position:{x:0,y:-this.roomHeight},mirrors:e,depth:1,opacity:.7}),e[1]&&i.push({position:{x:this.roomWidth,y:0},mirrors:e,depth:1,opacity:.7}),e[2]&&i.push({position:{x:0,y:this.roomHeight},mirrors:e,depth:1,opacity:.7}),e[3]&&i.push({position:{x:-this.roomWidth,y:0},mirrors:e,depth:1,opacity:.7}),i.forEach(s=>{if(s.depth===0)return;let c;s.position.y<0?c="top":s.position.x>0?c="right":s.position.y>0?c="bottom":c="left";const l=this.getMirrorPosition(c,d.position);r.push(this.reflectAcrossMirror(t.triangle.position,"triangle",c,s.depth,l),this.reflectAcrossMirror(t.viewer.position,"viewer",c,s.depth,l))}),{virtualObjects:r,virtualRooms:i}}getMirrorPosition(t,e){switch(t){case"top":return e.y;case"bottom":return e.y+this.roomHeight;case"left":return e.x;case"right":return e.x+this.roomWidth}}reflectAcrossMirror(t,e,o,r,i,d){const s={...t};let c=d?.flippedX||!1,l=d?.flippedY||!1;switch(o){case"top":const S=i??0;s.y=2*S-t.y,l=!l;break;case"right":const w=i??this.roomWidth;s.x=2*w-t.x,c=!c;break;case"bottom":const A=i??this.roomHeight;s.y=2*A-t.y,l=!l;break;case"left":const m=i??0;s.x=2*m-t.x,c=!c;break}return{id:`${e}-d${r}-${o}`,sourceType:e,position:s,flippedX:c,flippedY:l,depth:r,opacity:1-r*.3}}calculateRayPath(t,e,o){const r=[];if(r.push(t.position),t.depth===1){const i=t.id.split("-")[2],d=this.getRayMirrorIntersection(t.position,e,i);d&&r.push(d)}else t.depth>1;return r.push(e),r}getRayMirrorIntersection(t,e,o){switch(o){case"top":const r=-t.y/(e.y-t.y);if(r>=0&&r<=1){const c=t.x+r*(e.x-t.x);if(c>=0&&c<=this.roomWidth)return{x:c,y:0}}break;case"right":const i=(this.roomWidth-t.x)/(e.x-t.x);if(i>=0&&i<=1){const c=t.y+i*(e.y-t.y);if(c>=0&&c<=this.roomHeight)return{x:this.roomWidth,y:c}}break;case"bottom":const d=(this.roomHeight-t.y)/(e.y-t.y);if(d>=0&&d<=1){const c=t.x+d*(e.x-t.x);if(c>=0&&c<=this.roomWidth)return{x:c,y:this.roomHeight}}break;case"left":const s=-t.x/(e.x-t.x);if(s>=0&&s<=1){const c=t.y+s*(e.y-t.y);if(c>=0&&c<=this.roomHeight)return{x:0,y:c}}break}return null}}class P{state;reflectionEngine;selectedTouchAreas=new Set;constructor(){this.state={mode:"edit",room:{width:200,height:200,mirrors:[!1,!1,!1,!1]},objects:{triangle:{position:{x:100,y:75}},viewer:{position:{x:100,y:175}}},touchAreas:[],content:{problemText:"Click where you see reflections of the triangle",explanationText:"Light bounces off mirrors to create virtual images. The virtual images appear at the same distance behind the mirror as the object is in front of it.",correctFeedback:"Correct!",incorrectFeedback:"Try again!"},selectedVirtualObjectForRay:null,maxReflectionDepth:3},this.reflectionEngine=new F}setMode(t){this.state.mode=t,t==="play"&&this.selectedTouchAreas.clear()}getMode(){return this.state.mode}getObjects(){return{triangle:{...this.state.objects.triangle.position},viewer:{...this.state.objects.viewer.position}}}moveObject(t,e){if(this.state.mode!=="edit")return;const o=20,r={x:Math.max(o,Math.min(this.state.room.width-o,e.x)),y:Math.max(o,Math.min(this.state.room.height-o,e.y))};this.state.objects[t].position=r}getObjectPosition(t){return{...this.state.objects[t].position}}addTouchArea(t){if(this.state.mode!=="edit")return"";const e=`touch-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,o={id:e,position:t||{x:100,y:100},isCorrect:!0,radius:30};return this.state.touchAreas.push(o),e}moveTouchArea(t,e){if(this.state.mode!=="edit")return;const o=this.state.touchAreas.find(r=>r.id===t);o&&(o.position=e)}setTouchAreaCorrect(t,e){if(this.state.mode!=="edit")return;const o=this.state.touchAreas.find(r=>r.id===t);o&&(o.isCorrect=e)}deleteTouchArea(t){this.state.mode==="edit"&&(this.state.touchAreas=this.state.touchAreas.filter(e=>e.id!==t))}getAllTouchAreas(){return[...this.state.touchAreas]}setMirror(t,e){if(this.state.mode!=="edit")return;const o=this.getMirrorIndex(t);this.state.room.mirrors[o]=e}toggleMirror(t){if(this.state.mode!=="edit")return;const e=this.getMirrorIndex(t);this.state.room.mirrors[e]=!this.state.room.mirrors[e]}getMirrors(){return{top:this.state.room.mirrors[0],right:this.state.room.mirrors[1],bottom:this.state.room.mirrors[2],left:this.state.room.mirrors[3]}}getMirrorIndex(t){switch(t){case"top":return 0;case"right":return 1;case"bottom":return 2;case"left":return 3}}setProblemText(t){this.state.mode==="edit"&&(this.state.content.problemText=t)}setExplanationText(t){this.state.mode==="edit"&&(this.state.content.explanationText=t)}setCorrectFeedback(t){this.state.mode==="edit"&&(this.state.content.correctFeedback=t)}setIncorrectFeedback(t){this.state.mode==="edit"&&(this.state.content.incorrectFeedback=t)}getContent(){return{...this.state.content}}selectVirtualObjectForRay(t){this.state.mode==="edit"&&(this.state.selectedVirtualObjectForRay=t)}getSelectedVirtualObject(){return this.state.selectedVirtualObjectForRay}getVirtualObjects(){const t=this.reflectionEngine.calculateVirtualObjects(this.state.objects,this.state.room.mirrors,this.state.maxReflectionDepth);if(this.state.selectedVirtualObjectForRay){const e=t.virtualObjects.find(o=>o.id===this.state.selectedVirtualObjectForRay);e&&(e.rayPath=this.reflectionEngine.calculateRayPath(e,this.state.objects.viewer.position,this.state.room.mirrors))}return t}getVirtualRooms(){return this.reflectionEngine.calculateVirtualObjects(this.state.objects,this.state.room.mirrors,this.state.maxReflectionDepth).virtualRooms}selectTouchArea(t){this.state.mode==="play"&&this.selectedTouchAreas.add(t)}deselectTouchArea(t){this.state.mode==="play"&&this.selectedTouchAreas.delete(t)}getSelectedTouchAreas(){return Array.from(this.selectedTouchAreas)}submitAnswer(){if(this.state.mode!=="play")return{isCorrect:!1,selectedCorrect:[],selectedIncorrect:[],missedCorrect:[],message:"Can only submit in play mode"};const t=[],e=[],o=[];for(const d of this.selectedTouchAreas){const s=this.state.touchAreas.find(c=>c.id===d);s&&(s.isCorrect?t.push(d):e.push(d))}for(const d of this.state.touchAreas)d.isCorrect&&!this.selectedTouchAreas.has(d.id)&&o.push(d.id);const r=e.length===0&&o.length===0,i=r?this.state.content.correctFeedback||"Correct!":this.state.content.incorrectFeedback||"Try again!";return{isCorrect:r,selectedCorrect:t,selectedIncorrect:e,missedCorrect:o,message:i}}resetPuzzle(){this.selectedTouchAreas.clear()}exportJSON(){return JSON.stringify(this.state,null,2)}importJSON(t){try{const e=JSON.parse(t);e.mode&&e.room&&e.objects&&e.touchAreas&&e.content&&(this.state=e,this.selectedTouchAreas.clear())}catch(e){console.error("Failed to import JSON:",e)}}validateConfiguration(){const t=[];this.state.touchAreas.length===0&&t.push("No touch areas defined - puzzle cannot be played"),!this.state.touchAreas.some(i=>i.isCorrect)&&this.state.touchAreas.length>0&&t.push("No correct touch areas defined - puzzle has no solution"),this.state.touchAreas.length>=5&&t.push("5+ touch areas - puzzle is getting too complex");const o=t.length===0||t.length===1&&t[0].includes("getting too complex"),r=t.join(" â€¢ ");return{isValid:o,message:r}}isPointInRoom(t){return t.x>=0&&t.x<=this.state.room.width&&t.y>=0&&t.y<=this.state.room.height}transformToCanvas(t){return{x:t.x+300,y:t.y+300}}transformToRoom(t){return{x:t.x-300,y:t.y-300}}getState(){return this.state}}const u=new P;function O(){const n=document.getElementById("edit-mode-btn"),t=document.getElementById("play-mode-btn");n?.addEventListener("click",()=>{u.setMode("edit"),j()}),t?.addEventListener("click",()=>{u.setMode("play"),j()});const e=document.getElementById("export-btn"),o=document.getElementById("import-btn"),r=document.getElementById("import-input");e?.addEventListener("click",()=>{const h=u.exportJSON();$(h,"puzzle.json")}),o?.addEventListener("click",()=>{r?.click()}),r?.addEventListener("change",h=>{const g=h.target.files?.[0];if(g){const b=new FileReader;b.onload=x=>{const f=x.target?.result;u.importJSON(f),C()},b.readAsText(g)}});const i={top:document.getElementById("mirror-top"),right:document.getElementById("mirror-right"),bottom:document.getElementById("mirror-bottom"),left:document.getElementById("mirror-left")};Object.entries(i).forEach(([h,g])=>{g?.addEventListener("change",()=>{u.setMirror(h,g.checked),z(),T()})});const d=document.getElementById("problem-text"),s=document.getElementById("explanation-text"),c=document.getElementById("correct-feedback"),l=document.getElementById("incorrect-feedback");d?.addEventListener("input",()=>{u.setProblemText(d.value)}),s?.addEventListener("input",()=>{u.setExplanationText(s.value)}),c?.addEventListener("input",()=>{u.setCorrectFeedback(c.value)}),l?.addEventListener("input",()=>{u.setIncorrectFeedback(l.value)}),document.getElementById("add-touch-area-btn")?.addEventListener("click",()=>{u.addTouchArea({x:100,y:100}),T(),N()});const w=document.getElementById("submit-answer-btn"),A=document.getElementById("reset-btn"),m=document.getElementById("why-btn");w?.addEventListener("click",()=>{const h=u.submitAnswer();H(h)}),A?.addEventListener("click",()=>{u.resetPuzzle(),C()}),m?.addEventListener("click",()=>{const h=document.getElementById("explanation-container"),g=document.getElementById("explanation-display");h&&g&&(g.textContent=u.getContent().explanationText,h.style.display="block")}),C()}function j(){const n=document.getElementById("edit-mode-btn"),t=document.getElementById("play-mode-btn"),e=document.getElementById("edit-controls"),o=document.getElementById("play-controls");if(u.getMode()==="edit")n?.classList.add("active"),t?.classList.remove("active"),e&&(e.style.display="block"),o&&(o.style.display="none");else{n?.classList.remove("active"),t?.classList.add("active"),e&&(e.style.display="none"),o&&(o.style.display="block");const c=document.getElementById("problem-display");c&&(c.textContent=u.getContent().problemText)}const i=document.getElementById("feedback-container"),d=document.getElementById("explanation-container"),s=document.getElementById("submit-answer-btn");i&&(i.style.display="none"),d&&(d.style.display="none"),s&&(s.style.display="block")}function z(){const n=document.querySelector(".mirror-center");if(!n)return;const t=u.getMirrors();n.classList.toggle("mirror-top-active",t.top),n.classList.toggle("mirror-right-active",t.right),n.classList.toggle("mirror-bottom-active",t.bottom),n.classList.toggle("mirror-left-active",t.left)}function N(){const n=document.getElementById("configuration-warning"),t=document.getElementById("warning-message");if(!n||!t)return;const e=u.validateConfiguration();e.message?(t.textContent=e.message,n.style.display="flex"):n.style.display="none"}function H(n){const t=document.getElementById("feedback-container"),e=document.getElementById("feedback-message"),o=document.getElementById("submit-answer-btn");!t||!e||(e.textContent=n.message,e.className=n.isCorrect?"correct":"incorrect",t.style.display="block",o&&(o.style.display="none"))}function T(){const n=document.getElementById("canvas");if(!n)return;const t=document.getElementById("room-group")||M(n,"room-group"),e=document.getElementById("objects-group")||M(n,"objects-group"),o=document.getElementById("virtual-objects")||n.querySelector("#virtual-objects"),r=document.getElementById("virtual-rooms")||n.querySelector("#virtual-rooms"),i=document.getElementById("touch-areas-group")||M(n,"touch-areas-group"),d=document.getElementById("ray-paths-group")||M(n,"ray-paths-group");t.innerHTML="",e.innerHTML="",o&&(o.innerHTML=""),r&&(r.innerHTML=""),i.innerHTML="",d.innerHTML="";const s=200,l=(800-s)/2,S=(a,y)=>({x:a+l,y:y+l}),w=document.createElementNS("http://www.w3.org/2000/svg","rect");w.setAttribute("x","0"),w.setAttribute("y","0"),w.setAttribute("width","800"),w.setAttribute("height","800"),w.setAttribute("fill","#e0e0e0"),t.appendChild(w);const A=document.createElementNS("http://www.w3.org/2000/svg","rect");A.setAttribute("x",String(l)),A.setAttribute("y",String(l)),A.setAttribute("width",String(s)),A.setAttribute("height",String(s)),A.setAttribute("fill","#ffffff"),A.setAttribute("stroke","#333"),A.setAttribute("stroke-width","2"),t.appendChild(A);const m=u.getMirrors(),h="stroke: #4a90e2; stroke-width: 3; stroke-linecap: round;";if(m.top){const a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",String(l)),a.setAttribute("y1",String(l)),a.setAttribute("x2",String(l+s)),a.setAttribute("y2",String(l)),a.setAttribute("style",h),t.appendChild(a)}if(m.right){const a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",String(l+s)),a.setAttribute("y1",String(l)),a.setAttribute("x2",String(l+s)),a.setAttribute("y2",String(l+s)),a.setAttribute("style",h),t.appendChild(a)}if(m.bottom){const a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",String(l)),a.setAttribute("y1",String(l+s)),a.setAttribute("x2",String(l+s)),a.setAttribute("y2",String(l+s)),a.setAttribute("style",h),t.appendChild(a)}if(m.left){const a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",String(l)),a.setAttribute("y1",String(l)),a.setAttribute("x2",String(l)),a.setAttribute("y2",String(l+s)),a.setAttribute("style",h),t.appendChild(a)}const g=u.getObjects(),b=S(g.triangle.x,g.triangle.y),x=document.createElementNS("http://www.w3.org/2000/svg","polygon"),f=10,B=`${b.x},${b.y-f} ${b.x-f},${b.y+f} ${b.x+f},${b.y+f}`;x.setAttribute("points",B),x.setAttribute("fill","#ff6b6b"),x.setAttribute("stroke","#d63031"),x.setAttribute("stroke-width","2"),x.setAttribute("class","draggable-object"),x.setAttribute("data-object","triangle"),x.setAttribute("cursor",u.getMode()==="edit"?"move":"default"),e.appendChild(x);const I=S(g.viewer.x,g.viewer.y),E=document.createElementNS("http://www.w3.org/2000/svg","ellipse");E.setAttribute("cx",String(I.x)),E.setAttribute("cy",String(I.y)),E.setAttribute("rx","12"),E.setAttribute("ry","8"),E.setAttribute("fill","#333"),E.setAttribute("stroke","#000"),E.setAttribute("stroke-width","2"),E.setAttribute("class","draggable-object"),E.setAttribute("data-object","viewer"),E.setAttribute("cursor",u.getMode()==="edit"?"move":"default"),e.appendChild(E);const k=document.createElementNS("http://www.w3.org/2000/svg","circle");k.setAttribute("cx",String(I.x)),k.setAttribute("cy",String(I.y)),k.setAttribute("r","4"),k.setAttribute("fill","#fff"),k.setAttribute("pointer-events","none"),e.appendChild(k);const L=u.getVirtualObjects();L.virtualRooms.forEach(a=>{if(a.depth>0){const y=S(a.position.x,a.position.y),p=document.createElementNS("http://www.w3.org/2000/svg","rect");p.setAttribute("x",String(y.x)),p.setAttribute("y",String(y.y)),p.setAttribute("width",String(s)),p.setAttribute("height",String(s)),p.setAttribute("fill","none"),p.setAttribute("stroke","#999"),p.setAttribute("stroke-width","1"),p.setAttribute("stroke-dasharray","3,3"),p.setAttribute("opacity",String(a.opacity)),r&&r.appendChild(p)}}),L.virtualObjects.forEach(a=>{const y=S(a.position.x,a.position.y);if(a.sourceType==="triangle"){const p=document.createElementNS("http://www.w3.org/2000/svg","polygon"),v=`${y.x},${y.y-f} ${y.x-f},${y.y+f} ${y.x+f},${y.y+f}`;p.setAttribute("points",v),p.setAttribute("fill","#ff6b6b"),p.setAttribute("stroke","#d63031"),p.setAttribute("stroke-width","1"),p.setAttribute("opacity",String(a.opacity)),p.setAttribute("stroke-dasharray","2,2"),o&&o.appendChild(p)}}),u.getMode()==="edit"&&u.getAllTouchAreas().forEach(y=>{const p=S(y.position.x,y.position.y),v=document.createElementNS("http://www.w3.org/2000/svg","circle");v.setAttribute("cx",String(p.x)),v.setAttribute("cy",String(p.y)),v.setAttribute("r",String(y.radius)),v.setAttribute("fill",y.isCorrect?"rgba(76, 175, 80, 0.3)":"rgba(244, 67, 54, 0.3)"),v.setAttribute("stroke",y.isCorrect?"#4caf50":"#f44336"),v.setAttribute("stroke-width","2"),v.setAttribute("stroke-dasharray","5,5"),v.setAttribute("class","touch-area"),v.setAttribute("data-id",y.id),i.appendChild(v)})}function M(n,t){const e=document.createElementNS("http://www.w3.org/2000/svg","g");return e.setAttribute("id",t),n.appendChild(e),e}function C(){j(),z(),N(),T();const n=u.getContent(),t=document.getElementById("problem-text"),e=document.getElementById("explanation-text"),o=document.getElementById("correct-feedback"),r=document.getElementById("incorrect-feedback");t&&(t.value=n.problemText),e&&(e.value=n.explanationText),o&&(o.value=n.correctFeedback),r&&(r.value=n.incorrectFeedback);const i=u.getMirrors(),d=document.getElementById("mirror-top"),s=document.getElementById("mirror-right"),c=document.getElementById("mirror-bottom"),l=document.getElementById("mirror-left");d&&(d.checked=i.top),s&&(s.checked=i.right),c&&(c.checked=i.bottom),l&&(l.checked=i.left)}function $(n,t){const e=new Blob([n],{type:"application/json"}),o=URL.createObjectURL(e),r=document.createElement("a");r.href=o,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o)}function R(){const n=document.getElementById("canvas");if(!n)return;let t=!1,e=null,o={x:0,y:0};const r=200,d=(800-r)/2,s=10,c=12,l=8;function S(m,h){return{x:m-d,y:h-d}}function w(m){const h=n.getBoundingClientRect();return{x:m.clientX-h.left,y:m.clientY-h.top}}function A(m,h,g){let b,x,f,B;return g==="triangle"?(b=s,x=r-s,f=s,B=r-s):(b=c,x=r-c,f=l,B=r-l),{x:Math.max(b,Math.min(x,m)),y:Math.max(f,Math.min(B,h))}}n.addEventListener("mousedown",m=>{if(u.getMode()!=="edit")return;const g=m.target.getAttribute("data-object");if(g==="triangle"||g==="viewer"){t=!0,e=g;const b=w(m),x=u.getObjects(),f=e==="triangle"?x.triangle:x.viewer;o={x:b.x-(f.x+d),y:b.y-(f.y+d)},m.preventDefault()}}),n.addEventListener("mousemove",m=>{if(!t||!e)return;const h=w(m),g=S(h.x-o.x,h.y-o.y),b=A(g.x,g.y,e);u.moveObject(e,b),T(),m.preventDefault()}),n.addEventListener("mouseup",()=>{t=!1,e=null}),n.addEventListener("mouseleave",()=>{t=!1,e=null})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{O(),R(),C()}):(O(),R(),C());
