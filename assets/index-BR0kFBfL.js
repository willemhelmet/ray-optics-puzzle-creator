(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&r(n)}).observe(document,{childList:!0,subtree:!0});function e(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(o){if(o.ep)return;o.ep=!0;const s=e(o);fetch(o.href,s)}})();class C{roomWidth=200;roomHeight=200;calculateVirtualObjects(t,e,r){const o=[],s=[],n={position:{x:0,y:0}};return e[0]&&s.push({position:{x:0,y:-this.roomHeight},mirrors:e,depth:1,opacity:.7}),e[1]&&s.push({position:{x:this.roomWidth,y:0},mirrors:e,depth:1,opacity:.7}),e[2]&&s.push({position:{x:0,y:this.roomHeight},mirrors:e,depth:1,opacity:.7}),e[3]&&s.push({position:{x:-this.roomWidth,y:0},mirrors:e,depth:1,opacity:.7}),s.forEach(c=>{if(c.depth===0)return;let i;c.position.y<0?i="top":c.position.x>0?i="right":c.position.y>0?i="bottom":i="left";const l=this.getMirrorPosition(i,n.position);o.push(this.reflectAcrossMirror(t.triangle.position,"triangle",i,c.depth,l),this.reflectAcrossMirror(t.viewer.position,"viewer",i,c.depth,l))}),{virtualObjects:o,virtualRooms:s}}getMirrorPosition(t,e){switch(t){case"top":return e.y;case"bottom":return e.y+this.roomHeight;case"left":return e.x;case"right":return e.x+this.roomWidth}}reflectAcrossMirror(t,e,r,o,s,n){const c={...t};let i=n?.flippedX||!1,l=n?.flippedY||!1;switch(r){case"top":const x=s??0;c.y=2*x-t.y,l=!l;break;case"right":const m=s??this.roomWidth;c.x=2*m-t.x,i=!i;break;case"bottom":const p=s??this.roomHeight;c.y=2*p-t.y,l=!l;break;case"left":const f=s??0;c.x=2*f-t.x,i=!i;break}return{id:`${e}-d${o}-${r}`,sourceType:e,position:c,flippedX:i,flippedY:l,depth:o,opacity:1-o*.3}}calculateRayPath(t,e,r){const o=[];if(o.push(t.position),t.depth===1){const s=t.id.split("-")[2],n=this.getRayMirrorIntersection(t.position,e,s);n&&o.push(n)}else t.depth>1;return o.push(e),o}getRayMirrorIntersection(t,e,r){switch(r){case"top":const o=-t.y/(e.y-t.y);if(o>=0&&o<=1){const i=t.x+o*(e.x-t.x);if(i>=0&&i<=this.roomWidth)return{x:i,y:0}}break;case"right":const s=(this.roomWidth-t.x)/(e.x-t.x);if(s>=0&&s<=1){const i=t.y+s*(e.y-t.y);if(i>=0&&i<=this.roomHeight)return{x:this.roomWidth,y:i}}break;case"bottom":const n=(this.roomHeight-t.y)/(e.y-t.y);if(n>=0&&n<=1){const i=t.x+n*(e.x-t.x);if(i>=0&&i<=this.roomWidth)return{x:i,y:this.roomHeight}}break;case"left":const c=-t.x/(e.x-t.x);if(c>=0&&c<=1){const i=t.y+c*(e.y-t.y);if(i>=0&&i<=this.roomHeight)return{x:0,y:i}}break}return null}}class T{state;reflectionEngine;selectedTouchAreas=new Set;constructor(){this.state={mode:"edit",room:{width:200,height:200,mirrors:[!1,!1,!1,!1]},objects:{triangle:{position:{x:100,y:75}},viewer:{position:{x:100,y:175}}},touchAreas:[],content:{problemText:"Click where you see reflections of the triangle",explanationText:"Light bounces off mirrors to create virtual images. The virtual images appear at the same distance behind the mirror as the object is in front of it.",correctFeedback:"Correct!",incorrectFeedback:"Try again!"},selectedVirtualObjectForRay:null,maxReflectionDepth:3},this.reflectionEngine=new C}setMode(t){this.state.mode=t,t==="play"&&this.selectedTouchAreas.clear()}getMode(){return this.state.mode}moveObject(t,e){if(this.state.mode!=="edit")return;const r=20,o={x:Math.max(r,Math.min(this.state.room.width-r,e.x)),y:Math.max(r,Math.min(this.state.room.height-r,e.y))};this.state.objects[t].position=o}getObjectPosition(t){return{...this.state.objects[t].position}}addTouchArea(t){if(this.state.mode!=="edit")return"";const e=`touch-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,r={id:e,position:t||{x:100,y:100},isCorrect:!0,radius:30};return this.state.touchAreas.push(r),e}moveTouchArea(t,e){if(this.state.mode!=="edit")return;const r=this.state.touchAreas.find(o=>o.id===t);r&&(r.position=e)}setTouchAreaCorrect(t,e){if(this.state.mode!=="edit")return;const r=this.state.touchAreas.find(o=>o.id===t);r&&(r.isCorrect=e)}deleteTouchArea(t){this.state.mode==="edit"&&(this.state.touchAreas=this.state.touchAreas.filter(e=>e.id!==t))}getAllTouchAreas(){return[...this.state.touchAreas]}setMirror(t,e){if(this.state.mode!=="edit")return;const r=this.getMirrorIndex(t);this.state.room.mirrors[r]=e}toggleMirror(t){if(this.state.mode!=="edit")return;const e=this.getMirrorIndex(t);this.state.room.mirrors[e]=!this.state.room.mirrors[e]}getMirrors(){return{top:this.state.room.mirrors[0],right:this.state.room.mirrors[1],bottom:this.state.room.mirrors[2],left:this.state.room.mirrors[3]}}getMirrorIndex(t){switch(t){case"top":return 0;case"right":return 1;case"bottom":return 2;case"left":return 3}}setProblemText(t){this.state.mode==="edit"&&(this.state.content.problemText=t)}setExplanationText(t){this.state.mode==="edit"&&(this.state.content.explanationText=t)}setCorrectFeedback(t){this.state.mode==="edit"&&(this.state.content.correctFeedback=t)}setIncorrectFeedback(t){this.state.mode==="edit"&&(this.state.content.incorrectFeedback=t)}getContent(){return{...this.state.content}}selectVirtualObjectForRay(t){this.state.mode==="edit"&&(this.state.selectedVirtualObjectForRay=t)}getSelectedVirtualObject(){return this.state.selectedVirtualObjectForRay}getVirtualObjects(){const t=this.reflectionEngine.calculateVirtualObjects(this.state.objects,this.state.room.mirrors,this.state.maxReflectionDepth);if(this.state.selectedVirtualObjectForRay){const e=t.virtualObjects.find(r=>r.id===this.state.selectedVirtualObjectForRay);e&&(e.rayPath=this.reflectionEngine.calculateRayPath(e,this.state.objects.viewer.position,this.state.room.mirrors))}return t.virtualObjects}getVirtualRooms(){return this.reflectionEngine.calculateVirtualObjects(this.state.objects,this.state.room.mirrors,this.state.maxReflectionDepth).virtualRooms}selectTouchArea(t){this.state.mode==="play"&&this.selectedTouchAreas.add(t)}deselectTouchArea(t){this.state.mode==="play"&&this.selectedTouchAreas.delete(t)}getSelectedTouchAreas(){return Array.from(this.selectedTouchAreas)}submitAnswer(){if(this.state.mode!=="play")return{isCorrect:!1,selectedCorrect:[],selectedIncorrect:[],missedCorrect:[],message:"Can only submit in play mode"};const t=[],e=[],r=[];for(const n of this.selectedTouchAreas){const c=this.state.touchAreas.find(i=>i.id===n);c&&(c.isCorrect?t.push(n):e.push(n))}for(const n of this.state.touchAreas)n.isCorrect&&!this.selectedTouchAreas.has(n.id)&&r.push(n.id);const o=e.length===0&&r.length===0,s=o?this.state.content.correctFeedback||"Correct!":this.state.content.incorrectFeedback||"Try again!";return{isCorrect:o,selectedCorrect:t,selectedIncorrect:e,missedCorrect:r,message:s}}resetPuzzle(){this.selectedTouchAreas.clear()}exportJSON(){return JSON.stringify(this.state,null,2)}importJSON(t){try{const e=JSON.parse(t);e.mode&&e.room&&e.objects&&e.touchAreas&&e.content&&(this.state=e,this.selectedTouchAreas.clear())}catch(e){console.error("Failed to import JSON:",e)}}validateConfiguration(){const t=[];this.state.touchAreas.length===0&&t.push("No touch areas defined - puzzle cannot be played"),!this.state.touchAreas.some(s=>s.isCorrect)&&this.state.touchAreas.length>0&&t.push("No correct touch areas defined - puzzle has no solution"),this.state.touchAreas.length>=5&&t.push("5+ touch areas - puzzle is getting too complex");const r=t.length===0||t.length===1&&t[0].includes("getting too complex"),o=t.join(" â€¢ ");return{isValid:r,message:o}}isPointInRoom(t){return t.x>=0&&t.x<=this.state.room.width&&t.y>=0&&t.y<=this.state.room.height}transformToCanvas(t){return{x:t.x+300,y:t.y+300}}transformToRoom(t){return{x:t.x-300,y:t.y-300}}getState(){return this.state}}const d=new T;function B(){const a=document.getElementById("edit-mode-btn"),t=document.getElementById("play-mode-btn");a?.addEventListener("click",()=>{d.setMode("edit"),y()}),t?.addEventListener("click",()=>{d.setMode("play"),y()});const e=document.getElementById("export-btn"),r=document.getElementById("import-btn"),o=document.getElementById("import-input");e?.addEventListener("click",()=>{const u=d.exportJSON();L(u,"puzzle.json")}),r?.addEventListener("click",()=>{o?.click()}),o?.addEventListener("change",u=>{const h=u.target.files?.[0];if(h){const E=new FileReader;E.onload=v=>{const A=v.target?.result;d.importJSON(A),g()},E.readAsText(h)}});const s={top:document.getElementById("mirror-top"),right:document.getElementById("mirror-right"),bottom:document.getElementById("mirror-bottom"),left:document.getElementById("mirror-left")};Object.entries(s).forEach(([u,h])=>{h?.addEventListener("change",()=>{d.setMirror(u,h.checked),I(),b()})});const n=document.getElementById("problem-text"),c=document.getElementById("explanation-text"),i=document.getElementById("correct-feedback"),l=document.getElementById("incorrect-feedback");n?.addEventListener("input",()=>{d.setProblemText(n.value)}),c?.addEventListener("input",()=>{d.setExplanationText(c.value)}),i?.addEventListener("input",()=>{d.setCorrectFeedback(i.value)}),l?.addEventListener("input",()=>{d.setIncorrectFeedback(l.value)}),document.getElementById("add-touch-area-btn")?.addEventListener("click",()=>{d.addTouchArea({x:100,y:100}),b(),k()});const m=document.getElementById("submit-answer-btn"),p=document.getElementById("reset-btn"),f=document.getElementById("why-btn");m?.addEventListener("click",()=>{const u=d.submitAnswer();M(u)}),p?.addEventListener("click",()=>{d.resetPuzzle(),g()}),f?.addEventListener("click",()=>{const u=document.getElementById("explanation-container"),h=document.getElementById("explanation-display");u&&h&&(h.textContent=d.getContent().explanationText,u.style.display="block")}),g()}function y(){const a=document.getElementById("edit-mode-btn"),t=document.getElementById("play-mode-btn"),e=document.getElementById("edit-controls"),r=document.getElementById("play-controls");if(d.getMode()==="edit")a?.classList.add("active"),t?.classList.remove("active"),e&&(e.style.display="block"),r&&(r.style.display="none");else{a?.classList.remove("active"),t?.classList.add("active"),e&&(e.style.display="none"),r&&(r.style.display="block");const i=document.getElementById("problem-display");i&&(i.textContent=d.getContent().problemText)}const s=document.getElementById("feedback-container"),n=document.getElementById("explanation-container"),c=document.getElementById("submit-answer-btn");s&&(s.style.display="none"),n&&(n.style.display="none"),c&&(c.style.display="block")}function I(){const a=document.querySelector(".mirror-center");if(!a)return;const t=d.getMirrors();a.classList.toggle("mirror-top-active",t.top),a.classList.toggle("mirror-right-active",t.right),a.classList.toggle("mirror-bottom-active",t.bottom),a.classList.toggle("mirror-left-active",t.left)}function k(){const a=document.getElementById("configuration-warning"),t=document.getElementById("warning-message");if(!a||!t)return;const e=d.validateConfiguration();e.message?(t.textContent=e.message,a.style.display="flex"):a.style.display="none"}function M(a){const t=document.getElementById("feedback-container"),e=document.getElementById("feedback-message"),r=document.getElementById("submit-answer-btn");!t||!e||(e.textContent=a.message,e.className=a.isCorrect?"correct":"incorrect",t.style.display="block",r&&(r.style.display="none"))}function b(){console.log("Canvas update needed")}function g(){y(),I(),k(),b();const a=d.getContent(),t=document.getElementById("problem-text"),e=document.getElementById("explanation-text"),r=document.getElementById("correct-feedback"),o=document.getElementById("incorrect-feedback");t&&(t.value=a.problemText),e&&(e.value=a.explanationText),r&&(r.value=a.correctFeedback),o&&(o.value=a.incorrectFeedback);const s=d.getMirrors(),n=document.getElementById("mirror-top"),c=document.getElementById("mirror-right"),i=document.getElementById("mirror-bottom"),l=document.getElementById("mirror-left");n&&(n.checked=s.top),c&&(c.checked=s.right),i&&(i.checked=s.bottom),l&&(l.checked=s.left)}function L(a,t){const e=new Blob([a],{type:"application/json"}),r=URL.createObjectURL(e),o=document.createElement("a");o.href=r,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",B):B();
